function Experiment(t){this.container=t||"body",this.contains=0,this.expArr=[],this.UserDefinedVars={},this.currentStim=0}function Stimulus(t,e,r,n,o,i){if(void 0===t)throw"error: created object of type Stimulus must have 'id' property";if("string"!=typeof t)throw"error: Stimulus 'id' must be a string";if(void 0===e)throw"error: created object of type Stimulus must have 'duration' property ";if("number"!=typeof e)throw"error: property 'duration' of created Stimulus must be a number";if(void 0===r)throw"error: created object of type Stimulus must have 'ISI' property ";if("number"!=typeof r)throw"error: property 'ISI' of created Stimulus must be a number";if(void 0!==n&&"Boolean"!==n.constructor.name)throw"error: saveData parameter of created Stimulus object must be Boolean or left out";if(void 0!==o&&"Array"!==o.constructor.name)throw"error: listenTo parameter of created Stimulus object must either be 'Array' or left out";if(void 0!==i&&"number"!=typeof i)throw"error: correctResponse parameter of created Stimulus object must either be 'number' or left out";this.id=t,this.duration=e,this.ISI=r,this.saveData=n,this.listenTo=o,this.correctResponse=i,this.RT,this.correct,this.event,this.features=[],this.experiment}Experiment.prototype.add=function(t){var e=this;t.experiment=e,e.expArr.push(t),e.contains=e.contains+1},Experiment.prototype.addBlock=function(t){for(var e=0;t>e;e++)for(var r=1;r<arguments.length;r++)this.add(arguments[r])},Experiment.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},Experiment.prototype.countdown=function(t){var e=this,r=t/10,n=setInterval(function(){r--,0>=r&&(clearInterval(n),e.clear())},10)},Experiment.prototype.createCanvas=function(){$(this.container).append("<canvas id='myCanvas' width='"+($(window).width()-30)+"'height= '"+($(window).height()-30)+"'></canvas>"),this.canvas=document.getElementById("myCanvas"),this.context=this.canvas.getContext("2d")},Experiment.prototype.start=function(){this.createCanvas(),startExp(this.expArr)},Experiment.prototype.getNewX=function(t){return t+this.canvas.width/2},Experiment.prototype.getNewY=function(t){return this.canvas.height/2-t},Experiment.prototype.storeData=function(){for(var t=[],e=0;e<this.expArr.length;e++)t[e]=this.expArr[e].slimObject();return t=JSON.stringify(t)},Stimulus.prototype.showStimulus=function(){for(var t=0;t<this.features.length;t++)this.features[t]()},Stimulus.prototype.listen=function(){var t=this,e=0,r=performance.now(),n=!1,o=function(r){$(document).off(),t.event=r,t.RT=e,n=!0,t.correct=void 0===t.correctResponse?void 0:t.event===t.correctResponse?1:0},i=function(){t.RT=0,t.event=0,t.correct=void 0===t.correctResponse?void 0:t.event===t.correctResponse?1:0};if($(document).off(),$(document).on("keypress click",function(n){if(e=performance.now()-r,event=n.which,console.log(event),t.listenTo){if(event)for(var i=0;i<t.listenTo.length;i++)n.which===t.listenTo[i]&&o(event)}else o(event)}),0!==t.duration)var a=(t.duration+t.ISI)/10,s=setInterval(function(){a--,0>=a&&(clearInterval(s),n||i())},10)},Stimulus.prototype.present=function(){this.experiment.currentStim++,this.showStimulus(),this.saveData===!0&&this.listen(),0!==this.duration&&this.experiment.countdown(this.duration)},Stimulus.prototype.addText=function(t,e,r,n,o){var i=this,a=function(){var a=i.experiment.getNewX(n)||i.experiment.canvas.width/2,s=i.experiment.getNewY(o)||i.experiment.canvas.height/2;i.experiment.context.font=""+e+"px Arial"||"30px Arial",i.experiment.context.fillStyle=r||"black",i.experiment.context.textAlign="center",i.experiment.context.fillText(t,a,s+e/2.5)};i.features.push(a)},Stimulus.prototype.addCross=function(t,e){var r=this,n=function(){r.experiment.context.beginPath(),r.experiment.context.lineWidth=e,r.experiment.context.moveTo(r.experiment.canvas.width/2+t/2,r.experiment.canvas.height/2),r.experiment.context.lineTo(r.experiment.canvas.width/2-t/2,r.experiment.canvas.height/2),r.experiment.context.moveTo(r.experiment.canvas.width/2,r.experiment.canvas.height/2+t/2),r.experiment.context.lineTo(r.experiment.canvas.width/2,r.experiment.canvas.height/2-t/2),r.experiment.context.stroke()};r.features.push(n)},Stimulus.prototype.addCode=function(code){var draw=function(){eval(code)};that.features.push(draw)},Stimulus.prototype.removeFeatures=function(){this.features=[]},Stimulus.prototype.addExpVar=function(t,e){var r=this,n=function(){r.experiment.UserDefinedVars[t]=e};return r.features.push(n),e},Stimulus.prototype.slimObject=function(){data={};for(key in this)void 0!==this[key]&&"Function"!==this[key].constructor.name&&"Experiment"!==this[key].constructor.name&&"Array"!==this[key].constructor.name&&(data[key]=this[key]);return data},Stimulus.prototype.checkID=function(t){return this.id===t};var partExp=function(t){for(var e=0,r=[[]],n=0;n<t.length;n++)0===t[n].duration?(r[e].push(t[n]),n<t.length-1&&(r.push([]),e++)):r[e].push(t[n]);return r},runStimuli=function(t){for(var e=0,r=0;r<t.length;r++){var n=0;setTimeout(function(){t[n].present(t[n].duration),n++},e),e=e+t[r].duration+t[r].ISI}},getExpTime=function(t){for(var e=0,r=0;r<t.length;r++)e=e+t[r].duration+t[r].ISI;return e},startExp=function(t){var e=partExp(t),r=function(t,e){setTimeout(function(){n(t,e)},getExpTime(t[e-1]))},n=function(t,e){if(0===e)runStimuli(t[e]),r(t,e+1);else if(e<t.length){var n=t[e-1][t[e-1].length-1];$(document).on("keypress click",function(o){if(n.listenTo)for(var i=0;i<n.listenTo.length;i++)o.which===n.listenTo[i]&&($(document).off(),n.experiment.clear(),runStimuli(t[e]),r(t,e+1));else $(document).off(),n.experiment.clear(),runStimuli(t[e]),r(t,e+1)})}};n(e,0)},rndCol=function(){return"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+")"},rndInt=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},download=function(t,e,r){{var n=document,o=arguments,i=n.createElement("a"),a=(o[0],o[1]);o[2]||"text/plain"}if(i.href="data:"+r+"charset=utf-8,"+escape(t),window.MSBlobBuilder){var s=new MSBlobBuilder;return s.append(t),navigator.msSaveBlob(s,e)}if("download"in i)return i.setAttribute("download",a),i.innerHTML="downloading...",n.body.appendChild(i),setTimeout(function(){var t=n.createEvent("MouseEvents");t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(t),n.body.removeChild(i)},66),!0;var u=n.createElement("iframe");return n.body.appendChild(u),u.src="data:"+(o[2]?o[2]:"application/octet-stream")+(window.btoa?";base64":"")+","+(window.btoa?window.btoa:escape)(t),setTimeout(function(){n.body.removeChild(u)},333),!0},rndShuffleArray=function(t){for(var e=[],r=0;r<t.length;r++)if(0===e.length){var n=Math.floor(Math.random()*t.length);e.push(n)}else if(e.length>0){for(var n=Math.floor(Math.random()*t.length);-1!=e.indexOf(n);)var n=Math.floor(Math.random()*t.length);e.push(n)}for(var o=[],i=0;i<t.length;i++)o[i]=t[e[i]];return o};